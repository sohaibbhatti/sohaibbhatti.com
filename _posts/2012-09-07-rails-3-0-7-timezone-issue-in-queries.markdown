---
author: sohaibbbhatti
comments: true
date: 2012-09-07 07:27:25+00:00
layout: post
slug: rails-3-0-7-timezone-issue-in-queries
title: Rails 3.0.7 TimeZone issue in queries
wordpress_id: 129
categories:
- Ruby on Rails
tags:
- Bug
- Rails
- TimeZone
---

Recently I was facing a bug in which a mailer wasn't being sent out to users. After quite a lot of fruitless debugging, I stumbled upon an interesting problem.

The mailer was being triggered based on whether a certain scope returned a collection of objects. Oddly, it seemed to be working fine locally. Upon closer inspection, I realized that the time zone wasn't being accounted for in the SQL being generated by the queries visible in the log.

    
{% highlight ruby %}
scope :yesterday, lambda { where(:transaction_date_time => DateTime.yesterday.midnight + 2.hours .. DateTime.yesterday.midnight + 26.hours) }
{% endhighlight %}


After changing the class being used to obtain the current days midnight from DateTime to Date, I noticed that the time zone was now being accounted for.

    
{% highlight ruby %}
scope :yesterday, lambda { where(:transaction_date_time => Date.yesterday.midnight + 2.hours .. Date.yesterday.midnight + 26.hours) }
{% endhighlight %}


I checked whether this issue exists in the 3.2.x version of Rails, however I couldn't reproduce this issue. I still need to delve further into the root of this problem and see how it was fixed, however I've been bogged with work and other personal matters. Hopefully I'll soon be getting the time to have a better in-depth look at this issue.

If anyone faces a problem similar to this I'd recommend them to check whether this could be the cause. Hopefully it will save quite a bit of debugging time.
